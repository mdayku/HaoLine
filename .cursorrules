# HaoLine Cursor Rules

## Code Style (ALWAYS Follow)

When writing Python code:
- **Ruff-formatted**: 100 char line limit, double quotes, trailing commas in multi-line
- **Ruff-linted**: No unused imports, no undefined names, proper import sorting (I, F, E, W)
- **Type hints**: Add type hints to all function signatures (args and return types)
- **Docstrings**: Google-style docstrings for public functions/classes
- **No trailing whitespace or extra blank lines at end of file**

Example function:
```python
def analyze_model(
    model_path: Path,
    hardware: str = "auto",
    precision: str = "fp32",
) -> InspectionReport:
    """Analyze a model and return inspection report.

    Args:
        model_path: Path to the ONNX model file.
        hardware: Hardware profile name or 'auto' for detection.
        precision: Precision for estimates (fp32, fp16, int8).

    Returns:
        InspectionReport with analysis results.
    """
    ...
```

## Code Quality

**Before EVERY commit (MANDATORY):**
1. Run `ruff format src/haoline/` to format Python code
2. Run `ruff check src/haoline/ --fix` to fix linting issues
3. Verify both pass before committing

**Every 3 commits (or before any release):**
4. Run `mypy src/haoline/ --ignore-missing-imports` to check types
5. Fix any type errors before proceeding

Quick commands:
```bash
# Every commit (required):
ruff format src/haoline/; ruff check src/haoline/ --fix

# Every 3 commits or before release:
mypy src/haoline/ --ignore-missing-imports
```

**Commit frequency tracking:** Keep a mental note of commits since last mypy run. If unsure, just run it - it's fast.

### Common mypy Fixes

- **no-any-return**: Add explicit type cast or fix return type
  ```python
  # Bad: return some_dict.get("key")  # Returns Any
  # Good: return cast(str, some_dict.get("key"))
  # Or: result: str = some_dict.get("key", "")
  ```

- **assignment type mismatch**: Use correct types
  ```python
  # Bad: count: int = 1.5
  # Good: count: int = int(1.5)
  ```

- **numpy dtype issues**: Use `np.dtype` or `Any` for complex dtype expressions

## Git Workflow

- Always check `git status` before committing
- Use conventional commit messages (feat:, fix:, docs:, refactor:, test:, chore:)
- Push after committing to keep GitHub in sync

## Testing

- Run `pytest src/haoline/tests/ -v` before major changes
- CI runs on push to main - check GitHub Actions if build fails

## File Organization

- Core analysis: `src/haoline/` 
- Tests: `src/haoline/tests/`
- Format readers: `src/haoline/formats/`
- Eval import: `src/haoline/eval/`
- Docs: `README.md`, `PRD.md`, `BACKLOG.md`, `Architecture.md`, `DEPLOYMENT.md`, `PRIVACY.md`

## Version Compatibility (IMPORTANT)

**HuggingFace Spaces Deployment:**
- `streamlit_app.py` is copied directly from GitHub to HF Spaces
- BUT `haoline` package is installed from PyPI (may be older version)
- This means `streamlit_app.py` code may run against older `InspectionReport`, etc.

**Rule:** When accessing NEW attributes on core classes in `streamlit_app.py`:
```python
# BAD - will crash if attribute doesn't exist in PyPI version:
if report.universal_graph:
    ...

# GOOD - safe access with fallback:
if hasattr(report, "universal_graph") and report.universal_graph:
    ...

# Or:
universal_graph = getattr(report, "universal_graph", None)
if universal_graph:
    ...
```

**Core classes that may have version mismatches:**
- `InspectionReport`
- `ModelMetadata`
- `GraphSummary`
- Any dataclass in `report.py`, `schema.py`

**When to use safe access:**
- In `streamlit_app.py` for any attribute added after v0.2.4
- When the attribute was added in a commit but not yet published to PyPI

## Documentation Archival (IMPORTANT)

**When editing PRD.md or BACKLOG.md:**

These files can grow large and consume context window. After editing:

1. **Check for completed epics** in BACKLOG.md - if an epic is 100% complete, move detailed task lists to `PRDBacklogArchive.md`
2. **Check for old delta log entries** in PRD.md - entries older than 7 days should be moved to `PRDBacklogArchive.md`
3. **Keep summaries** - completed epics should retain a one-line summary in BACKLOG.md, not full task lists

**Archive file:** `PRDBacklogArchive.md` - contains:
- Detailed task lists from completed epics
- Historical delta log entries
- This is for reference only, not active development

**What to keep in active docs:**
- BACKLOG.md: Progress summary table, in-progress epics, future epics
- PRD.md: Requirements, specs, architecture decisions, recent (7 days) delta log

**Example trimming:**
```markdown
# Before (in BACKLOG.md):
## Epic 5: Visualization (COMPLETE - 52/52)
### Story 5.1: Chart Infrastructure
- [x] Task 5.1.1: Set up matplotlib...
- [x] Task 5.1.2: Create theme...
(20 more tasks)

# After:
## Epic 5: Visualization (COMPLETE - 52/52)
*Archived to PRDBacklogArchive.md*
```

